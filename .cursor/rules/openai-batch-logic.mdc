---
description: OpenAI Batch API Logic
---

# OpenAI Batch APIë¥¼ í†µí•œ Clickbait ì ìˆ˜ ì¸¡ì • ì‹œìŠ¤í…œ

## ğŸ¯ ê°œìš”
ë„¤ì´ë²„ ë‰´ìŠ¤ Article ë°ì´í„°ì— ëŒ€í•´ OpenAI Batch APIë¥¼ í™œìš©í•˜ì—¬ clickbait ì ìˆ˜(0-100)ì™€ íŒë‹¨ ê·¼ê±°ë¥¼ ì¸¡ì •í•˜ëŠ” ì‹œìŠ¤í…œ

## ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ìˆœì„œ

### 1. ë°°ì¹˜ ìƒíƒœ í™•ì¸ ë‹¨ê³„
- **ëª©ì **: í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ OpenAI batch ì‘ì—… ì¡´ì¬ ì—¬ë¶€ í™•ì¸
- **êµ¬í˜„**: 
  - Supabase `batch` í…Œì´ë¸” ì¡°íšŒ
  - `status = 'in_progress'` ì¡°ê±´ìœ¼ë¡œ í™œì„± ë°°ì¹˜ ê²€ìƒ‰
  - ë°°ì¹˜ ì¡´ì¬ ì—¬ë¶€ì— ë”°ë¼ í›„ì²˜ë¦¬/ì‹ ê·œìƒì„± ë¶„ê¸°

### 2. ë°°ì¹˜ í›„ì²˜ë¦¬ ë¡œì§ (ì‹¤í–‰ì¤‘ì¸ ë°°ì¹˜ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°)

#### 2-1. ë°°ì¹˜ ê²°ê³¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
```python
# OpenAI Python API í™œìš©
client = OpenAI(api_key=openai_api_key)
batch = client.batches.retrieve(batch_id)
if batch.status == 'completed':
    result_file = client.files.content(batch.output_file_id)
```

#### 2-2. ê²°ê³¼ íŒŒì‹± ë° ë°ì´í„° ì¶”ì¶œ
- **ì…ë ¥**: OpenAI Batch API ê²°ê³¼ JSONL íŒŒì¼
- **ì¶œë ¥**: Articleë³„ `clickbait_score`, `clickbait_explanation` ë§¤í•‘
- **êµ¬í˜„ ê³ ë ¤ì‚¬í•­**:
  - JSONL íŒŒì¼ ë¼ì¸ë³„ íŒŒì‹±
  - custom_idë¥¼ í†µí•œ Article ID ë§¤í•‘
  - OpenAI ì‘ë‹µì—ì„œ JSON íŒŒì‹± (clickbait_score, clickbait_explanation ì¶”ì¶œ)
  - íŒŒì‹± ì‹¤íŒ¨ ì¼€ì´ìŠ¤ ì—ëŸ¬ í•¸ë“¤ë§

#### 2-3. Supabase Article í…Œì´ë¸” Bulk ì—…ë°ì´íŠ¸
```python
# Bulk upsertë¥¼ ìœ„í•œ ë°ì´í„° ì¤€ë¹„
bulk_updates = []
for article_id, result in parsed_results.items():
    bulk_updates.append({
        'id': article_id,
        'clickbait_score': result['clickbait_score'],
        'clickbait_explanation': result['clickbait_explanation'],
        'updated_at': datetime.now().isoformat()
    })

# í•œë²ˆì— ëª¨ë“  ë°ì´í„° ì—…ë°ì´íŠ¸ (ì„±ëŠ¥ìƒ í›¨ì”¬ íš¨ìœ¨ì )
if bulk_updates:
    response = supabase.table('Article').upsert(bulk_updates).execute()
    logger.info(f"Bulk updated {len(bulk_updates)} articles")
```

#### 2-4. ë°°ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ì‹ ê·œ ë°°ì¹˜ ìƒì„±ìœ¼ë¡œ ì´ë™
- `batch` í…Œì´ë¸”ì˜ í•´ë‹¹ ë°°ì¹˜ ìƒíƒœë¥¼ `completed`ë¡œ ì—…ë°ì´íŠ¸
- ì²˜ë¦¬ëœ Article ìˆ˜ ê¸°ë¡
- ì‹ ê·œ ë°°ì¹˜ ìƒì„± ë‹¨ê³„ë¡œ ì´ë™

### 3. ì‹ ê·œ ë°°ì¹˜ ìƒì„± ë¡œì§ (ì‹¤í–‰ì¤‘ì¸ ë°°ì¹˜ê°€ ì—†ëŠ” ê²½ìš°)

#### 3-1. ëŒ€ìƒ Article ë°ì´í„° ì¡°íšŒ
```python
# clickbait_scoreê°€ nullì¸ ë°ì´í„° 800ê°œ ì¡°íšŒ (ì˜¤ë˜ëœ ìˆœ)
articles = supabase.table('Article').select('*')\
    .is_('clickbait_score', 'null')\
    .order('created_at', desc=False)\
    .limit(800)\
    .execute()
```

#### 3-2. í”„ë¡¬í”„íŠ¸ ìƒì„± ë° Batch API ì…ë ¥ í¬ë§· ë³€í™˜
```python
# ê° Articleë³„ í”„ë¡¬í”„íŠ¸ ìƒì„±
batch_requests = []
for article in articles:
    prompt = generate_clickbait_prompt(article)
    batch_request = {
        "custom_id": f"article_{article['id']}",
        "method": "POST",
        "url": "/v1/chat/completions",
        "body": {
            "model": "gpt-4o-mini",
            "messages": [{"role": "user", "content": prompt}],
            "max_tokens": 500,
            "response_format": {"type": "json_object"}
        }
    }
    batch_requests.append(batch_request)
```

#### 3-3. OpenAI Batch API ìƒì„± í˜¸ì¶œ
```python
# JSONL íŒŒì¼ ìƒì„± ë° ì—…ë¡œë“œ
batch_file = client.files.create(
    file=batch_requests_jsonl,
    purpose="batch"
)

# ë°°ì¹˜ ìƒì„±
batch = client.batches.create(
    input_file_id=batch_file.id,
    endpoint="/v1/chat/completions",
    completion_window="24h"
)

# Supabase batch í…Œì´ë¸”ì— ë°°ì¹˜ ì •ë³´ ì €ì¥
supabase.table('batch').insert({
    'batch_id': batch.id,
    'status': 'in_progress',
    'article_count': len(articles),
    'created_at': datetime.now().isoformat()
}).execute()
```

## ğŸ”§ êµ¬í˜„ íŒŒì¼ êµ¬ì¡°

### ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼
- `scripts/process_clickbait_batch.py`: ë©”ì¸ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸

### í•µì‹¬ ëª¨ë“ˆ
- `src/core/batch_processor.py`: ë°°ì¹˜ ì²˜ë¦¬ í•µì‹¬ ë¡œì§
- `src/core/openai_client.py`: OpenAI API í´ë¼ì´ì–¸íŠ¸ ë˜í¼
- `src/core/prompt_generator.py`: Clickbait íŒë‹¨ í”„ë¡¬í”„íŠ¸ ìƒì„±
- `src/core/bulk_updater.py`: Bulk upsert ìµœì í™” ë° ì—ëŸ¬ í•¸ë“¤ë§

### ì„¤ì • íŒŒì¼
- `src/config/prompts.py`: Clickbait íŒë‹¨ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
- `src/config/batch_settings.py`: ë°°ì¹˜ ì²˜ë¦¬ ê´€ë ¨ ì„¤ì •

### ìœ í‹¸ë¦¬í‹° ëª¨ë“ˆ
- `src/utils/batch_utils.py`: ë°°ì¹˜ ë¶„í• , ì¬ì‹œë„ ë¡œì§
- `src/utils/performance_monitor.py`: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° ë©”íŠ¸ë¦­

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì°¸ê³ 

### batch í…Œì´ë¸” (ì‹ ê·œ ìƒì„± í•„ìš”)
```sql
CREATE TABLE batch (
    id SERIAL PRIMARY KEY,
    batch_id VARCHAR(255) UNIQUE NOT NULL,
    status VARCHAR(50) NOT NULL, -- 'in_progress', 'completed', 'failed'
    article_count INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE,
    error_message TEXT
);
```

## âš™ï¸ í™˜ê²½ ì„¤ì •

### í™˜ê²½ ë³€ìˆ˜
- `OPENAI_API_KEY`: OpenAI API í‚¤
- `SUPABASE_URL`: Supabase í”„ë¡œì íŠ¸ URL  
- `SUPABASE_SERVICE_ROLE_KEY`: Supabase ì„œë¹„ìŠ¤ í‚¤

### GitHub Actions ìŠ¤ì¼€ì¤„ë§
- **ì‹¤í–‰ ì£¼ê¸°**: ë§¤ì‹œê°„ ì •ê° (0ë¶„)
- **Cron í‘œí˜„ì‹**: `0 * * * *`
- **íƒ€ì„ì•„ì›ƒ**: 30ë¶„

## âš¡ ì„±ëŠ¥ ìµœì í™”

### Bulk Upsert ì¥ì 
- **ì„±ëŠ¥ í–¥ìƒ**: ê°œë³„ ì—…ë°ì´íŠ¸ ëŒ€ì‹  í•œë²ˆì˜ ìš”ì²­ìœ¼ë¡œ ì²˜ë¦¬ (ìµœëŒ€ 800ê°œê¹Œì§€)
- **ë„¤íŠ¸ì›Œí¬ íš¨ìœ¨ì„±**: API ìš”ì²­ íšŸìˆ˜ ëŒ€í­ ê°ì†Œ (800íšŒ â†’ 1íšŒ)
- **íŠ¸ëœì­ì…˜ ë³´ì¥**: ëª¨ë“  ì—…ë°ì´íŠ¸ê°€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬

### Bulk Upsert ì‚¬ìš©ë²•
```python
# upsertëŠ” idë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡´ì¬í•˜ë©´ UPDATE, ì—†ìœ¼ë©´ INSERT
bulk_updates = [
    {'id': 1, 'clickbait_score': 85, 'clickbait_explanation': '...'},
    {'id': 2, 'clickbait_score': 42, 'clickbait_explanation': '...'}
]
response = supabase.table('Article').upsert(bulk_updates).execute()
```

### ë°°ì¹˜ í¬ê¸° ê³ ë ¤ì‚¬í•­
- **ê¶Œì¥ ë°°ì¹˜ í¬ê¸°**: 500-1000ê°œ (Supabase ì œí•œì— ë”°ë¼ ì¡°ì •)
- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: í° ë°°ì¹˜ì¼ìˆ˜ë¡ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€
- **ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„**: ì¼ë¶€ ì‹¤íŒ¨ ì‹œ ì‹¤íŒ¨í•œ í•­ëª©ë§Œ ì¬ì‹œë„

## ğŸ›¡ï¸ ì—ëŸ¬ í•¸ë“¤ë§

### ë°°ì¹˜ ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ
- `batch` í…Œì´ë¸” ìƒíƒœë¥¼ `failed`ë¡œ ì—…ë°ì´íŠ¸
- ì—ëŸ¬ ë©”ì‹œì§€ ê¸°ë¡
- ìŠ¬ë™/ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡

### ê°œë³„ Article íŒŒì‹± ì‹¤íŒ¨ ì‹œ  
- íŒŒì‹± ì‹¤íŒ¨í•œ Articleì€ bulk_updatesì—ì„œ ì œì™¸
- ì‹¤íŒ¨í•œ Article IDì™€ ì—ëŸ¬ ë‚´ìš© ë¡œê·¸ ê¸°ë¡
- ë‹¤ìŒ ë°°ì¹˜ì—ì„œ ì¬ì‹œë„ (clickbait_scoreê°€ ì—¬ì „íˆ nullì´ë¯€ë¡œ)

### Bulk Upsert ì‹¤íŒ¨ ì‹œ
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë‚˜ DB ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì‹œ ì „ì²´ ë°°ì¹˜ ì‹¤íŒ¨
- ì‹¤íŒ¨ ì‹œ ê°œë³„ upsertë¡œ fallback ì²˜ë¦¬ ì˜µì…˜
- ë°°ì¹˜ë¥¼ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ì—¬ ì¬ì‹œë„

### OpenAI API í•œë„ ì´ˆê³¼ ì‹œ
- ë°°ì¹˜ ìƒì„± ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ ì‹œê°„ì— ì¬ì‹œë„
- Rate limit ì—ëŸ¬ ì²˜ë¦¬

## ğŸ“ ë¡œê¹… ì „ëµ

### ë¡œê·¸ ë ˆë²¨ë³„ ê¸°ë¡ ì‚¬í•­
- **INFO**: ë°°ì¹˜ ìƒì„±/ì™„ë£Œ, ì²˜ë¦¬ëœ Article ìˆ˜
- **WARNING**: ê°œë³„ íŒŒì‹± ì‹¤íŒ¨, API ì‘ë‹µ ì´ìƒ
- **ERROR**: ë°°ì¹˜ ì²˜ë¦¬ ì‹¤íŒ¨, DB ì—°ê²° ì‹¤íŒ¨
- **DEBUG**: ìƒì„¸ ì²˜ë¦¬ ê³¼ì •, API ìš”ì²­/ì‘ë‹µ

### ë¡œê·¸ íŒŒì¼ êµ¬ì¡°
```
logs/
â”œâ”€â”€ batch_processing.log      # ë©”ì¸ ë¡œê·¸
â”œâ”€â”€ openai_api.log           # OpenAI API ê´€ë ¨ ë¡œê·¸  
â””â”€â”€ error.log                # ì—ëŸ¬ë§Œ ë³„ë„ ê¸°ë¡
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- í”„ë¡¬í”„íŠ¸ ìƒì„± ë¡œì§ í…ŒìŠ¤íŠ¸
- ë°°ì¹˜ ê²°ê³¼ íŒŒì‹± ë¡œì§ í…ŒìŠ¤íŠ¸
- Database ì—°ì‚° í…ŒìŠ¤íŠ¸

### í†µí•© í…ŒìŠ¤íŠ¸  
- ì „ì²´ ë°°ì¹˜ ì²˜ë¦¬ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- OpenAI API Mockì„ í™œìš©í•œ End-to-End í…ŒìŠ¤íŠ¸

### ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
- 800ê°œ Article ë°°ì¹˜ ì²˜ë¦¬ ì‹œê°„ ì¸¡ì •
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
