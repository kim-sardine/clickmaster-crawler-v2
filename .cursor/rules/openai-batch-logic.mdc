---
description: OpenAI Batch API Logic
---

# OpenAI Batch APIë¥¼ í†µí•œ Clickbait ì ìˆ˜ ì¸¡ì • ì‹œìŠ¤í…œ

## ğŸ¯ ê°œìš”
ë„¤ì´ë²„ ë‰´ìŠ¤ Article ë°ì´í„°ì— ëŒ€í•´ OpenAI Batch APIë¥¼ í™œìš©í•˜ì—¬ clickbait ì ìˆ˜(0-100)ì™€ íŒë‹¨ ê·¼ê±°ë¥¼ ì¸¡ì •í•˜ëŠ” ì‹œìŠ¤í…œ

## ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ìˆœì„œ

### 1. ë°°ì¹˜ ìƒíƒœ í™•ì¸ ë‹¨ê³„ âœ… êµ¬í˜„ì™„ë£Œ
- **ëª©ì **: í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ OpenAI batch ì‘ì—… ì¡´ì¬ ì—¬ë¶€ í™•ì¸
- **êµ¬í˜„**: 
  - Supabase `batch_status` í…Œì´ë¸” ì¡°íšŒ
  - `status IN ('pending', 'in_progress', 'validating', 'finalizing')` ì¡°ê±´ìœ¼ë¡œ ëª¨ë“  í™œì„± ë°°ì¹˜ ê²€ìƒ‰
  - ëª¨ë“  í™œì„± ë°°ì¹˜ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ (ë™ì‹œ ì‹¤í–‰ ë°©ì§€)

### 2. ë°°ì¹˜ í›„ì²˜ë¦¬ ë¡œì§ (ì‹¤í–‰ì¤‘ì¸ ë°°ì¹˜ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°) âœ… êµ¬í˜„ì™„ë£Œ

#### 2-1. ë°°ì¹˜ ê²°ê³¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
```python
# OpenAI Python API í™œìš©
client = OpenAI(api_key=openai_api_key)
batch = client.batches.retrieve(batch_id)
if batch.status == 'completed':
    result_file = client.files.content(batch.output_file_id)
```
- **ë©±ë“±ì„± ìµœì í™”**: ì´ë¯¸ ì™„ë£Œëœ ë°°ì¹˜ëŠ” ì¬ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
- **ìºì‹±**: ë‹¤ìš´ë¡œë“œí•œ ê²°ê³¼ë¥¼ ì„ì‹œ ì €ì¥í•˜ì—¬ ì¬ì‹œë„ ì‹œ í™œìš©

#### 2-2. ê²°ê³¼ íŒŒì‹± ë° ë°ì´í„° ì¶”ì¶œ âœ… êµ¬í˜„ì™„ë£Œ
- **ì…ë ¥**: OpenAI Batch API ê²°ê³¼ JSONL íŒŒì¼
- **ì¶œë ¥**: Articleë³„ `clickbait_score`, `clickbait_explanation` ë§¤í•‘
- **êµ¬í˜„ íŠ¹ì§•**:
  - JSONL íŒŒì¼ ë¼ì¸ë³„ íŒŒì‹±
  - custom_idë¥¼ í†µí•œ Article ID ë§¤í•‘ (`article_{uuid}` í˜•ì‹)
  - JSON Schema ì‘ë‹µ í˜•ì‹ìœ¼ë¡œ ì•ˆì •ì ì¸ íŒŒì‹±
  - ìƒì„¸í•œ íŒŒì‹± ì—ëŸ¬ ë©”ì‹œì§€ ë° ë¡œê¹…
  - score ê°’ ê²€ì¦ (reason â†’ clickbait_explanation ë§¤í•‘)

#### 2-3. Supabase Article í…Œì´ë¸” Bulk ì—…ë°ì´íŠ¸ âœ… êµ¬í˜„ì™„ë£Œ
```python
# Bulk upsertë¥¼ ìœ„í•œ ë°ì´í„° ì¤€ë¹„
bulk_updates = []
for article_id, result in parsed_results.items():
    bulk_updates.append({
        'id': article_id,
        'clickbait_score': result['clickbait_score'],
        'clickbait_explanation': result['clickbait_explanation'],
        'updated_at': datetime.now().isoformat()
    })

# í•œë²ˆì— ëª¨ë“  ë°ì´í„° ì—…ë°ì´íŠ¸ (ì„±ëŠ¥ìƒ í›¨ì”¬ íš¨ìœ¨ì )
if bulk_updates:
    response = supabase.table('articles').upsert(bulk_updates).execute()
    logger.info(f"Bulk updated {len(bulk_updates)} articles")
```
- **ë©±ë“±ì„± ë³´ì¥**: ì´ë¯¸ ì ìˆ˜ê°€ ìˆëŠ” ê¸°ì‚¬ë„ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸
- **ì‹¤íŒ¨ ì‹œ ê°œë³„ ì²˜ë¦¬**: Bulk ì‹¤íŒ¨ ì‹œ ê°œë³„ ì—…ë°ì´íŠ¸ë¡œ fallback

#### 2-4. ë°°ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ì‹ ê·œ ë°°ì¹˜ ìƒì„±ìœ¼ë¡œ ì´ë™ âœ… êµ¬í˜„ì™„ë£Œ
- `batch_status` í…Œì´ë¸”ì˜ í•´ë‹¹ ë°°ì¹˜ ìƒíƒœë¥¼ `completed`ë¡œ ì—…ë°ì´íŠ¸
- ì²˜ë¦¬ëœ Article ìˆ˜ ê¸°ë¡
- ì—ëŸ¬ ë°œìƒ ì‹œ `failed` ìƒíƒœë¡œ ì—…ë°ì´íŠ¸ ë° ìƒì„¸ ì—ëŸ¬ ë©”ì‹œì§€ ì €ì¥
- ëª¨ë“  í™œì„± ë°°ì¹˜ ì²˜ë¦¬ ì™„ë£Œ í›„ ì‹ ê·œ ë°°ì¹˜ ìƒì„± ë‹¨ê³„ë¡œ ì´ë™

### 3. ì‹ ê·œ ë°°ì¹˜ ìƒì„± ë¡œì§ (ì‹¤í–‰ì¤‘ì¸ ë°°ì¹˜ê°€ ì—†ëŠ” ê²½ìš°) âœ… êµ¬í˜„ì™„ë£Œ

#### 3-1. ëŒ€ìƒ Article ë°ì´í„° ì¡°íšŒ
```python
# clickbait_scoreê°€ nullì¸ ë°ì´í„° ì¡°íšŒ (ì˜¤ë˜ëœ ìˆœ)
articles = supabase.table('articles').select('*')\
    .is_('clickbait_score', 'null')\
    .order('created_at', desc=False)\
    .limit(batch_size)\
    .execute()
```
- **ë°°ì¹˜ í¬ê¸°**: ê¸°ë³¸ 100ê°œ, ìµœëŒ€ 800ê°œ (íŒŒë¼ë¯¸í„°ë¡œ ì¡°ì • ê°€ëŠ¥)
- **ë™ì‹œì„± ì œì–´**: ì´ì¤‘/ì‚¼ì¤‘ ì²´í¬ë¡œ ë™ì‹œ ë°°ì¹˜ ìƒì„± ë°©ì§€

#### 3-2. í”„ë¡¬í”„íŠ¸ ìƒì„± ë° Batch API ì…ë ¥ í¬ë§· ë³€í™˜ âœ… êµ¬í˜„ì™„ë£Œ
```python
# ê° Articleë³„ í”„ë¡¬í”„íŠ¸ ìƒì„±
batch_requests = []
for article in articles:
    prompt = generate_clickbait_prompt(article['title'], article['content'])
    batch_request = {
        "custom_id": f"article_{article['id']}",
        "method": "POST",
        "url": "/v1/chat/completions",
        "body": {
            "model": "gpt-4o-mini",
            "messages": [
                {
                    "role": "system",
                    "content": "ë‹¹ì‹ ì€ ë‰´ìŠ¤ì˜ ì œëª©ê³¼ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ í´ë¦­ë² ì´íŠ¸ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤..."
                },
                {"role": "user", "content": prompt}
            ],
            "response_format": {
                "type": "json_schema",
                "json_schema": {
                    "name": "clickbait_evaluation",
                    "strict": True,
                    "schema": CLICKBAIT_EVALUATION_SCHEMA
                }
            }
        }
    }
    batch_requests.append(batch_request)
```

#### 3-3. OpenAI Batch API ìƒì„± í˜¸ì¶œ âœ… êµ¬í˜„ì™„ë£Œ
```python
# JSONL íŒŒì¼ ìƒì„± ë° ì—…ë¡œë“œ
jsonl_content = "\n".join(json.dumps(req) for req in batch_requests)
with tempfile.NamedTemporaryFile(mode="w", suffix=".jsonl", delete=False) as f:
    f.write(jsonl_content)
    temp_file_path = f.name

# íŒŒì¼ ì—…ë¡œë“œ
with open(temp_file_path, "rb") as file:
    uploaded_file = client.files.create(file=file, purpose="batch")

# ë°°ì¹˜ ìƒì„±
batch = client.batches.create(
    input_file_id=uploaded_file.id,
    endpoint="/v1/chat/completions",
    completion_window="24h"
)

# Supabase batch_status í…Œì´ë¸”ì— ë°°ì¹˜ ì •ë³´ ì €ì¥
supabase.table('batch_status').insert({
    'batch_id': batch.id,
    'status': 'in_progress',
    'request_count': len(articles),
    'input_file_id': uploaded_file.id,
    'created_at': datetime.now().isoformat()
}).execute()
```

## ğŸ”§ êµ¬í˜„ íŒŒì¼ êµ¬ì¡° âœ… êµ¬í˜„ì™„ë£Œ

### ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼
- `scripts/openai_batch_monitor.py`: ë©”ì¸ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (ë°°ì¹˜ ëª¨ë‹ˆí„°ë§ ë° ìƒì„±)

### í•µì‹¬ ëª¨ë“ˆ
- `src/core/batch_processor.py`: ë°°ì¹˜ ì²˜ë¦¬ í•µì‹¬ ë¡œì§ (ë©±ë“±ì„±, ë™ì‹œì„± ì œì–´ í¬í•¨)
- `src/core/openai_client.py`: OpenAI API í´ë¼ì´ì–¸íŠ¸ ë˜í¼
- `src/core/prompt_generator.py`: Clickbait íŒë‹¨ í”„ë¡¬í”„íŠ¸ ìƒì„± ë° JSON Schema ì •ì˜
- `src/core/bulk_updater.py`: Bulk upsert ìµœì í™” ë° ì—ëŸ¬ í•¸ë“¤ë§

### ì„¤ì • íŒŒì¼
- `src/config/settings.py`: í™˜ê²½ë³€ìˆ˜ ë° ê¸°ë³¸ ì„¤ì • ê´€ë¦¬

### ìœ í‹¸ë¦¬í‹° ëª¨ë“ˆ
- `src/utils/batch_utils.py`: ë°°ì¹˜ ë¶„í• , ì¬ì‹œë„ ë¡œì§
- `src/utils/performance_monitor.py`: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° ë©”íŠ¸ë¦­

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì°¸ê³ 

### batch_status í…Œì´ë¸” âœ… êµ¬í˜„ì™„ë£Œ
```sql
CREATE TABLE batch_status (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    batch_id TEXT UNIQUE NOT NULL,
    status TEXT NOT NULL, -- 'pending', 'in_progress', 'validating', 'finalizing', 'completed', 'failed', 'cancelled'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    input_file_id TEXT,
    output_file_id TEXT,
    error_file_id TEXT,
    request_count INTEGER DEFAULT 0,
    completed_count INTEGER DEFAULT 0,
    failed_count INTEGER DEFAULT 0,
    metadata JSONB,
    error_message TEXT
);
```

## âš™ï¸ í™˜ê²½ ì„¤ì •

### í™˜ê²½ ë³€ìˆ˜
- `OPENAI_API_KEY`: OpenAI API í‚¤
- `SUPABASE_URL`: Supabase í”„ë¡œì íŠ¸ URL  
- `SUPABASE_SERVICE_ROLE_KEY`: Supabase ì„œë¹„ìŠ¤ í‚¤

### GitHub Actions ìŠ¤ì¼€ì¤„ë§ âœ… êµ¬í˜„ì™„ë£Œ
- **ì‹¤í–‰ ì£¼ê¸°**: ë§¤ì‹œê°„ 27ë¶„ (ë¶€í•˜ ë¶„ì‚°ì„ ìœ„í•´ ì •ê° í”¼í•¨)
- **Cron í‘œí˜„ì‹**: `27 * * * *`
- **íƒ€ì„ì•„ì›ƒ**: 45ë¶„
- **ì›Œí¬í”Œë¡œìš° íŒŒì¼**: `.github/workflows/hourly-batch-monitor.yml`

## âš¡ ì„±ëŠ¥ ìµœì í™”

### Bulk Upsert ì¥ì 
- **ì„±ëŠ¥ í–¥ìƒ**: ê°œë³„ ì—…ë°ì´íŠ¸ ëŒ€ì‹  í•œë²ˆì˜ ìš”ì²­ìœ¼ë¡œ ì²˜ë¦¬ (ìµœëŒ€ 800ê°œê¹Œì§€)
- **ë„¤íŠ¸ì›Œí¬ íš¨ìœ¨ì„±**: API ìš”ì²­ íšŸìˆ˜ ëŒ€í­ ê°ì†Œ (800íšŒ â†’ 1íšŒ)
- **íŠ¸ëœì­ì…˜ ë³´ì¥**: ëª¨ë“  ì—…ë°ì´íŠ¸ê°€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬

### Bulk Upsert ì‚¬ìš©ë²•
```python
# upsertëŠ” idë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡´ì¬í•˜ë©´ UPDATE, ì—†ìœ¼ë©´ INSERT
bulk_updates = [
    {'id': 1, 'clickbait_score': 85, 'clickbait_explanation': '...'},
    {'id': 2, 'clickbait_score': 42, 'clickbait_explanation': '...'}
]
response = supabase.table('Article').upsert(bulk_updates).execute()
```

### ë°°ì¹˜ í¬ê¸° ê³ ë ¤ì‚¬í•­ âœ… êµ¬í˜„ì™„ë£Œ
- **ê¸°ë³¸ ë°°ì¹˜ í¬ê¸°**: 100ê°œ (ì•ˆì •ì„± ìš°ì„ )
- **ìµœëŒ€ ë°°ì¹˜ í¬ê¸°**: 800ê°œ (íŒŒë¼ë¯¸í„°ë¡œ ì¡°ì • ê°€ëŠ¥)
- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: ë°°ì¹˜ ì²˜ë¦¬ í›„ ì¦‰ì‹œ ë©”ëª¨ë¦¬ í•´ì œ
- **ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„**: ë‹¤ìŒ ë°°ì¹˜ ì‹¤í–‰ ì‹œ ìë™ ì¬ì²˜ë¦¬ (clickbait_scoreê°€ nullì¸ ê¸°ì‚¬ ì¬ì¡°íšŒ)

## ğŸ›¡ï¸ ì—ëŸ¬ í•¸ë“¤ë§

### ë°°ì¹˜ ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ
- `batch` í…Œì´ë¸” ìƒíƒœë¥¼ `failed`ë¡œ ì—…ë°ì´íŠ¸
- ì—ëŸ¬ ë©”ì‹œì§€ ê¸°ë¡
- ìŠ¬ë™/ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡

### ê°œë³„ Article íŒŒì‹± ì‹¤íŒ¨ ì‹œ  
- íŒŒì‹± ì‹¤íŒ¨í•œ Articleì€ bulk_updatesì—ì„œ ì œì™¸
- ì‹¤íŒ¨í•œ Article IDì™€ ì—ëŸ¬ ë‚´ìš© ë¡œê·¸ ê¸°ë¡
- ë‹¤ìŒ ë°°ì¹˜ì—ì„œ ì¬ì‹œë„ (clickbait_scoreê°€ ì—¬ì „íˆ nullì´ë¯€ë¡œ)

### Bulk Upsert ì‹¤íŒ¨ ì‹œ
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë‚˜ DB ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì‹œ ì „ì²´ ë°°ì¹˜ ì‹¤íŒ¨
- ì‹¤íŒ¨ ì‹œ ê°œë³„ upsertë¡œ fallback ì²˜ë¦¬ ì˜µì…˜
- ë°°ì¹˜ë¥¼ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ì—¬ ì¬ì‹œë„

### OpenAI API í•œë„ ì´ˆê³¼ ì‹œ
- ë°°ì¹˜ ìƒì„± ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ ì‹œê°„ì— ì¬ì‹œë„
- Rate limit ì—ëŸ¬ ì²˜ë¦¬

## ğŸ“ ë¡œê¹… ì „ëµ

### ë¡œê·¸ ë ˆë²¨ë³„ ê¸°ë¡ ì‚¬í•­
- **INFO**: ë°°ì¹˜ ìƒì„±/ì™„ë£Œ, ì²˜ë¦¬ëœ Article ìˆ˜
- **WARNING**: ê°œë³„ íŒŒì‹± ì‹¤íŒ¨, API ì‘ë‹µ ì´ìƒ
- **ERROR**: ë°°ì¹˜ ì²˜ë¦¬ ì‹¤íŒ¨, DB ì—°ê²° ì‹¤íŒ¨
- **DEBUG**: ìƒì„¸ ì²˜ë¦¬ ê³¼ì •, API ìš”ì²­/ì‘ë‹µ

### ë¡œê·¸ íŒŒì¼ êµ¬ì¡°
```
logs/
â”œâ”€â”€ batch_processing.log      # ë©”ì¸ ë¡œê·¸
â”œâ”€â”€ openai_api.log           # OpenAI API ê´€ë ¨ ë¡œê·¸  
â””â”€â”€ error.log                # ì—ëŸ¬ë§Œ ë³„ë„ ê¸°ë¡
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- í”„ë¡¬í”„íŠ¸ ìƒì„± ë¡œì§ í…ŒìŠ¤íŠ¸
- ë°°ì¹˜ ê²°ê³¼ íŒŒì‹± ë¡œì§ í…ŒìŠ¤íŠ¸
- Database ì—°ì‚° í…ŒìŠ¤íŠ¸

### í†µí•© í…ŒìŠ¤íŠ¸  
- ì „ì²´ ë°°ì¹˜ ì²˜ë¦¬ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- OpenAI API Mockì„ í™œìš©í•œ End-to-End í…ŒìŠ¤íŠ¸

### ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
- 800ê°œ Article ë°°ì¹˜ ì²˜ë¦¬ ì‹œê°„ ì¸¡ì •
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
