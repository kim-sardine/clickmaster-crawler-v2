---
globs: "src/database/*"
description: "Supabase ë°ì´í„°ë² ì´ìŠ¤ ì—°ì‚° ê°€ì´ë“œ"
---

# Supabase ë°ì´í„°ë² ì´ìŠ¤ ì—°ì‚°

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°

### í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
```python
from supabase import create_client, Client
import os

url = os.environ.get("SUPABASE_URL")
key = os.environ.get("SUPABASE_SERVICE_ROLE_KEY")
supabase: Client = create_client(url, key)
```

### í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬
- `SUPABASE_URL`: Supabase í”„ë¡œì íŠ¸ URL
- `SUPABASE_SERVICE_ROLE_KEY`: ì„œë¹„ìŠ¤ ë¡¤ í‚¤ (ì½ê¸°/ì“°ê¸° ê¶Œí•œ)
- `SUPABASE_SERVICE_ROLE_KEY`: ê´€ë¦¬ì ê¶Œí•œ í‚¤

## ğŸ“ ê¸°ë³¸ CRUD ì—°ì‚°

### ê¸°ì‚¬ ë°ì´í„° ì‚½ì…
```python
def insert_article(article_data):
    """ê¸°ì‚¬ ë°ì´í„° ì‚½ì…"""
    return supabase.table('articles').insert(article_data).execute()
```

### ê¸°ì ì •ë³´ ì¡°íšŒ/ì‚½ì…
```python
def get_or_create_journalist(name, publisher, naver_uuid=None):
    """ê¸°ì ì •ë³´ ì¡°íšŒ ë˜ëŠ” ìƒì„±"""
    # ê¸°ì¡´ ê¸°ì ì¡°íšŒ
    existing = supabase.table('journalists').select('*').eq('name', name).eq('publisher', publisher).execute()
    
    if existing.data:
        return existing.data[0]
    
    # ìƒˆ ê¸°ì ìƒì„±
    new_journalist = {
        'name': name,
        'publisher': publisher,
        'naver_uuid': naver_uuid
    }
    return supabase.table('journalists').insert(new_journalist).execute()
```

## ğŸ” ì¿¼ë¦¬ íŒ¨í„´

### ë°°ì¹˜ ì‚½ì…
```python
def bulk_insert_articles(articles_list):
    """ë°°ì¹˜ ê¸°ì‚¬ ì‚½ì…"""
    batch_size = 100
    for i in range(0, len(articles_list), batch_size):
        batch = articles_list[i:i + batch_size]
        result = supabase.table('articles').insert(batch).execute()
        if not result.data:
            # ì—ëŸ¬ ì²˜ë¦¬
            handle_insert_error(batch)
```

### ì¤‘ë³µ ì²´í¬
```python
def check_duplicate_article(naver_url):
    """ì¤‘ë³µ ê¸°ì‚¬ ì²´í¬"""
    result = supabase.table('articles').select('id').eq('naver_url', naver_url).execute()
    return len(result.data) > 0
```

### ë¯¸ì²˜ë¦¬ ê¸°ì‚¬ ì¡°íšŒ
```python
def get_unprocessed_articles(limit=1000):
    """OpenAI ì²˜ë¦¬ë˜ì§€ ì•Šì€ ê¸°ì‚¬ ì¡°íšŒ"""
    return supabase.table('articles').select('*').is_('clickbait_score', 'null').limit(limit).execute()
```

## ğŸ”„ ë°°ì¹˜ ìƒíƒœ ê´€ë¦¬

### ë°°ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸
```python
def update_batch_status(batch_id, status, **kwargs):
    """ë°°ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸"""
    update_data = {
        'status': status,
        'updated_at': 'now()'
    }
    update_data.update(kwargs)
    
    return supabase.table('batch_status').update(update_data).eq('batch_id', batch_id).execute()
```

### ì§„í–‰ì¤‘ì¸ ë°°ì¹˜ ì¡°íšŒ
```python
def get_active_batches():
    """ì§„í–‰ì¤‘ì¸ ë°°ì¹˜ ì¡°íšŒ"""
    return supabase.table('batch_status').select('*').in_('status', ['validating', 'in_progress', 'finalizing']).execute()
```

## ğŸ“Š í†µê³„ ë° ì§‘ê³„

### ì–¸ë¡ ì‚¬ë³„ í†µê³„
```python
def get_publisher_stats():
    """ì–¸ë¡ ì‚¬ë³„ ê¸°ì‚¬ í†µê³„"""
    return supabase.rpc('get_publisher_statistics').execute()
```

### ê¸°ìë³„ ì ìˆ˜ ì—…ë°ì´íŠ¸
```python
def update_journalist_scores(journalist_id):
    """ê¸°ìë³„ í‰ê·  ì ìˆ˜ ì—…ë°ì´íŠ¸"""
    return supabase.rpc('update_journalist_stats', {'journalist_id': journalist_id}).execute()
```

## ğŸ› ï¸ ì—ëŸ¬ í•¸ë“¤ë§

### ì—°ê²° ì¬ì‹œë„
```python
import time
from functools import wraps

def retry_db_operation(max_retries=3, delay=1):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(max_retries):
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    if attempt == max_retries - 1:
                        raise
                    time.sleep(delay * (2 ** attempt))
            return None
        return wrapper
    return decorator
```

### ì¤‘ë³µ í‚¤ ì—ëŸ¬ ì²˜ë¦¬
```python
def handle_duplicate_key_error(data):
    """ì¤‘ë³µ í‚¤ ì—ëŸ¬ ì²˜ë¦¬"""
    # ê¸°ì¡´ ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ì‹œë„
    if 'naver_url' in data:
        return supabase.table('articles').update(data).eq('naver_url', data['naver_url']).execute()
```

## ğŸ”’ ë³´ì•ˆ ë° ê¶Œí•œ

### RLS (Row Level Security) ì •ì±…
- ì½ê¸° ê¶Œí•œ: ëª¨ë“  ì‚¬ìš©ì
- ì“°ê¸° ê¶Œí•œ: ì„œë¹„ìŠ¤ ë¡¤ë§Œ

### ë¯¼ê°í•œ ë°ì´í„° ì²˜ë¦¬
- ê¸°ì ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹
- ë¡œê·¸ì—ì„œ ë¯¼ê° ë°ì´í„° ì œì™¸
- API í‚¤ í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬

## ğŸ“ˆ ì„±ëŠ¥ ìµœì í™”

### ì¸ë±ìŠ¤ í™œìš©
- `articles.naver_url` ì¸ë±ìŠ¤ í™œìš©
- `articles.published_at` ì‹œê°„ ê¸°ë°˜ ì¿¼ë¦¬
- `journalists.name + publisher` ë³µí•© ì¸ë±ìŠ¤

### ë°°ì¹˜ ì²˜ë¦¬ ìµœì í™”
- íŠ¸ëœì­ì…˜ ë‹¨ìœ„ ìµœì í™”
- ì—°ê²° í’€ ì‚¬ìš©
- ì¿¼ë¦¬ ìºì‹± ì „ëµ

### ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±
- ëŒ€ëŸ‰ ë°ì´í„° ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
- ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ìµœì í™”
