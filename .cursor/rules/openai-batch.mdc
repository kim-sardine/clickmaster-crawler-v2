---
globs: "src/core/*,scripts/process_completed_batches.py,scripts/monitor_batches.py"
description: "OpenAI Batch API ì²˜ë¦¬ ë¡œì§ êµ¬í˜„ ê°€ì´ë“œ"
---

# OpenAI Batch API ì²˜ë¦¬ ë¡œì§

## ğŸ¤– OpenAI Batch API ê°œìš”

### API ì›Œí¬í”Œë¡œìš°
1. **ë°°ì¹˜ ìƒì„±** â†’ ì…ë ¥ ë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ
2. **ë°°ì¹˜ ì‹¤í–‰** â†’ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬
3. **ìƒíƒœ ëª¨ë‹ˆí„°ë§** â†’ ì£¼ê¸°ì ìœ¼ë¡œ ìƒíƒœ í™•ì¸
4. **ê²°ê³¼ ë‹¤ìš´ë¡œë“œ** â†’ ì™„ë£Œ ì‹œ ê²°ê³¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ

### ë°°ì¹˜ ìƒíƒœ ê´€ë¦¬
- `validating`: ì…ë ¥ ê²€ì¦ ì¤‘
- `in_progress`: ì²˜ë¦¬ ì§„í–‰ ì¤‘
- `finalizing`: ì²˜ë¦¬ ì™„ë£Œ ì¤‘
- `completed`: ì™„ë£Œ
- `failed`: ì‹¤íŒ¨
- `expired`: ë§Œë£Œ
- `cancelled`: ì·¨ì†Œ

## ğŸ“ í”„ë¡¬í”„íŠ¸ ì„¤ê³„

### Clickbait ì ìˆ˜ ì¸¡ì • í”„ë¡¬í”„íŠ¸
> **ì°¸ê³ **: ì‹¤ì œ í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì€ `keywords-config.mdc`ì˜ **ê¸°ë³¸ Clickbait íŒë³„ í”„ë¡¬í”„íŠ¸** ì„¹ì…˜ì„ ì°¸ì¡°í•˜ì„¸ìš”.

**í”„ë¡¬í”„íŠ¸ ì£¼ìš” íŠ¹ì§•:**
- 5ë‹¨ê³„ ì²´ê³„ì  ë¶„ì„ ê³¼ì •
- 0-100 ì ìˆ˜ êµ¬ê°„ë³„ í‰ê°€ ê¸°ì¤€
- ì¶œë ¥ í˜•ì‹: `score : [ì •ìˆ˜]`, `reason : [ì„¤ëª…]`
- ë³¸ë¬¸ ë‚´ìš© ì œí•œ: ìµœëŒ€ 700ì

### í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ê´€ë¦¬
> **ì°¸ê³ **: í”„ë¡¬í”„íŠ¸ ë²„ì „ ê´€ë¦¬, A/B í…ŒìŠ¤íŠ¸, ì–¸ë¡ ì‚¬ë³„ íŠ¹í™” í”„ë¡¬í”„íŠ¸ ë“±ì€ `keywords-config.mdc`ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

**ë°°ì¹˜ ì²˜ë¦¬ì—ì„œì˜ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©ë²•:**
- `src/config/prompts.py`ì—ì„œ í”„ë¡¬í”„íŠ¸ ë¡œë“œ
- ë°°ì¹˜ ìƒì„± ì‹œ í”„ë¡¬í”„íŠ¸ ë²„ì „ ì„ íƒ
- í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì— `{title}`, `{content}` ë³€ìˆ˜ ì‚½ì…

## ğŸ”§ ë°°ì¹˜ ì²˜ë¦¬ êµ¬í˜„

### ì…ë ¥ ë°ì´í„° ì²˜ë¦¬
```python
import re

def prepare_articles_for_batch(articles):
    """ë°°ì¹˜ ì²˜ë¦¬ë¥¼ ìœ„í•œ ê¸°ì‚¬ ë°ì´í„° ì¤€ë¹„"""
    processed_articles = []
    
    for article in articles:
        # ë°ì´í„° ê²€ì¦
        if not article.get('title') or not article.get('content'):
            continue
            
        # ë‚´ìš© ê¸¸ì´ ì œí•œ (700ì)
        content = article['content'][:700]
        
        # HTML íƒœê·¸ ì œê±°
        content = re.sub(r'<[^>]+>', '', content)
        
        # ì¤‘ë³µ ê³µë°± ì œê±°
        content = re.sub(r'\s+', ' ', content).strip()
        
        processed_articles.append({
            'id': article['id'],
            'title': article['title'],
            'content': content
        })
    
    return processed_articles
```

### ë°°ì¹˜ ìƒì„± ë¡œì§
```python
def create_batch_request(articles, prompt_version="v1.1"):
    """ë°°ì¹˜ ìš”ì²­ ìƒì„±"""
    from src.config.prompts import get_prompt_template
    
    prompt_template = get_prompt_template(prompt_version)
    batch_requests = []
    
    for article in articles:
        # í”„ë¡¬í”„íŠ¸ì— ê¸°ì‚¬ ì •ë³´ ì‚½ì…
        formatted_prompt = prompt_template.format(
            title=article['title'],
            content=article['content'][:700]  # 700ì ì œí•œ
        )
        
        request = {
            "custom_id": f"article_{article['id']}",
            "method": "POST",
            "url": "/v1/chat/completions",
            "body": {
                "model": "gpt-4o-mini",
                "messages": [
                    {
                        "role": "system",
                        "content": "ë‰´ìŠ¤ì˜ ì œëª©ê³¼ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ í´ë¦­ë² ì´íŠ¸ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ëŠ” ì „ë¬¸ê°€"
                    },
                    {
                        "role": "user",
                        "content": formatted_prompt
                    }
                ],
                "max_tokens": 500,
                "temperature": 0.1
            }
        }
        batch_requests.append(request)
    
    return batch_requests
```

**ë°°ì¹˜ ìƒì„± ì œì•½ì‚¬í•­:**
- ì¼ì¼ ìµœëŒ€ ë°°ì¹˜ ìˆ˜ ì œí•œ (10ê°œ)
- ë°°ì¹˜ë‹¹ ìµœëŒ€ ìš”ì²­ ìˆ˜ (50,000ê°œ)
- ì…ë ¥ íŒŒì¼ í¬ê¸° ì œí•œ (100MB)
- ì¤‘ë³µ ì œê±° ë° ê²€ì¦

## ğŸ“Š ìƒíƒœ ëª¨ë‹ˆí„°ë§

### ë°°ì¹˜ ìƒíƒœ í…Œì´ë¸”
```sql
CREATE TABLE batch_status (
  id UUID PRIMARY KEY,
  batch_id TEXT UNIQUE NOT NULL,
  status TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  input_file_id TEXT,
  output_file_id TEXT,
  error_file_id TEXT,
  request_count INTEGER DEFAULT 0,
  completed_count INTEGER DEFAULT 0,
  failed_count INTEGER DEFAULT 0
);
```

### ëª¨ë‹ˆí„°ë§ ì£¼ê¸°
- **ì§„í–‰ ì¤‘**: 10ë¶„ë§ˆë‹¤ ìƒíƒœ í™•ì¸
- **ì™„ë£Œë¨**: ì¦‰ì‹œ ê²°ê³¼ ì²˜ë¦¬
- **ì‹¤íŒ¨**: ì—ëŸ¬ ë¡œê·¸ ê¸°ë¡ ë° ì•Œë¦¼

## ğŸ”„ ê²°ê³¼ ì²˜ë¦¬

### ì¶œë ¥ ë°ì´í„° íŒŒì‹±
```python
def parse_batch_result(result_line):
    """ë°°ì¹˜ ê²°ê³¼ íŒŒì‹±"""
    data = json.loads(result_line)
    custom_id = data['custom_id']
    
    if data['response']['status_code'] == 200:
        content = data['response']['body']['choices'][0]['message']['content']
        return parse_clickbait_score(content)
    else:
        return handle_error(data['response'])
```

### ì ìˆ˜ íŒŒì‹± ê·œì¹™
```python
import re

def parse_clickbait_score(content):
    """OpenAI ì‘ë‹µì—ì„œ í´ë¦­ë² ì´íŠ¸ ì ìˆ˜ ì¶”ì¶œ"""
    # ìƒˆë¡œìš´ ì¶œë ¥ í˜•ì‹: score : [ì •ìˆ˜], reason : [ì„¤ëª…]
    score_match = re.search(r'score\s*:\s*(\d+)', content, re.IGNORECASE)
    reason_match = re.search(r'reason\s*:\s*(.+)', content, re.IGNORECASE | re.DOTALL)
    
    if score_match:
        score = int(score_match.group(1))
        reason = reason_match.group(1).strip() if reason_match else ""
        
        # ì ìˆ˜ ë²”ìœ„ ê²€ì¦ (0-100)
        if 0 <= score <= 100:
            return {
                'clickbait_score': score,
                'score_explanation': reason
            }
    
    # íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ë°˜í™˜
    return {
        'clickbait_score': None,
        'score_explanation': f"ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {content[:100]}..."
    }
```

**íŒŒì‹± ì—ëŸ¬ ì²˜ë¦¬:**
- ì ìˆ˜ ì¶”ì¶œ ì‹¤íŒ¨ ì‹œ `None` ë°˜í™˜
- ì ìˆ˜ ë²”ìœ„ ë²—ì–´ë‚¨ ì‹œ ì¬ê²€ì¦ ìš”ì²­
- ì‘ë‹µ í˜•ì‹ ë¶ˆì¼ì¹˜ ì‹œ ë¡œê·¸ ê¸°ë¡

## ğŸ› ï¸ ì—ëŸ¬ í•¸ë“¤ë§

### ë°°ì¹˜ ì‹¤íŒ¨ ì²˜ë¦¬
- **ë¶€ë¶„ ì‹¤íŒ¨**: ì„±ê³µí•œ ê²°ê³¼ë§Œ ì²˜ë¦¬
- **ì „ì²´ ì‹¤íŒ¨**: ì¬ì‹œë„ ë¡œì§ êµ¬í˜„
- **íƒ€ì„ì•„ì›ƒ**: 24ì‹œê°„ í›„ ìë™ ë§Œë£Œ

### ë³µêµ¬ ì „ëµ
- ì‹¤íŒ¨í•œ ìš”ì²­ ì¬ë°°ì¹˜
- ì…ë ¥ ë°ì´í„° ê²€ì¦ ê°•í™”
- í† í° ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§

## ğŸ’° ë¹„ìš© ê´€ë¦¬

### í† í° ì‚¬ìš©ëŸ‰ ì¶”ì 
- ì…ë ¥ í† í° ìˆ˜ ê³„ì‚°
- ì¶œë ¥ í† í° ìˆ˜ ëª¨ë‹ˆí„°ë§
- ì¼ì¼/ì›”ê°„ ë¹„ìš© í•œë„ ì„¤ì •

### ìµœì í™” ì „ëµ
- í”„ë¡¬í”„íŠ¸ ê¸¸ì´ ìµœì í™”
- ë°°ì¹˜ í¬ê¸° ì¡°ì •
- ëª¨ë¸ ì„ íƒ ìµœì í™” (gpt-4o-mini ì‚¬ìš©)
